<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE Conquest: Ultimate Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .status-badge {
            transition: all 0.2s ease-in-out;
        }
        .status-badge:hover {
            transform: scale(1.05);
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* For Firefox */
        html {
            scrollbar-width: thin;
            scrollbar-color: #94a3b8 #f1f5f9;
        }
        .topic-link {
            cursor: pointer;
            transition: color 0.2s;
        }
        .topic-link:hover {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Main Content -->
    <div id="main-content">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-rocket text-3xl text-blue-600"></i>
                        <h1 class="text-xl sm:text-2xl font-bold ml-3">JEE Conquest</h1>
                    </div>
                    <div id="user-info" class="text-xs text-slate-400"></div>
                </div>
                <div id="motivational-quote" class="text-center py-4 border-t border-slate-200">
                    <p class="text-sm sm:text-base italic text-slate-600">"</p>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Tabs -->
            <div class="border-b border-slate-200 mb-6">
                <nav class="flex -mb-px" aria-label="Tabs">
                    <button data-tab="dashboard" class="tab-btn tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Dashboard</button>
                    <button data-tab="schedule" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 mx-4">Schedule</button>
                    <button data-tab="physics" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 mx-4">Physics</button>
                    <button data-tab="chemistry" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 mx-4">Chemistry</button>
                    <button data-tab="mathematics" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 mx-4">Mathematics</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Dashboard -->
                <div id="dashboard-content" class="tab-pane">
                    <!-- Dashboard content here -->
                </div>
                
                <!-- Schedule -->
                <div id="schedule-content" class="tab-pane hidden">
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <h3 class="text-lg font-semibold text-slate-800">Schedule Settings</h3>
                        <div class="mt-4">
                            <label for="start-date" class="block text-sm font-medium text-slate-700">Preparation Start Date:</label>
                            <input type="date" id="start-date" class="mt-1 block w-full md:w-1/3 rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                    
                    <div id="current-week-view">
                        <!-- "This Week" content will be rendered here -->
                    </div>

                    <div id="revision-view" class="mt-8">
                        <!-- "Topics for Revision" will be rendered here -->
                    </div>
                </div>

                <!-- Subject Panes (generated by JS) -->
                <div id="physics-content" class="tab-pane hidden"></div>
                <div id="chemistry-content" class="tab-pane hidden"></div>
                <div id="mathematics-content" class="tab-pane hidden"></div>
            </div>
        </main>
    </div>
    
    <!-- Topic Modal -->
    <!-- ... same as before ... -->


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // PASTE YOUR FIREBASE CONFIGURATION HERE
        // =================================================================================
        const firebaseConfig = {
  apiKey: "AIzaSyBgtyCnRBDGdDzJBndb9y0a5sA7xC19Ivk",
  authDomain: "jee-conquest-tracker.firebaseapp.com",
  projectId: "jee-conquest-tracker",
  storageBucket: "jee-conquest-tracker.firebasestorage.app",
  messagingSenderId: "585429898670",
  appId: "1:585429898670:web:777027d3a685209b45e43f"
};
        // =================================================================================

        // --- DATA SOURCE ---
        const jeeSyllabus = { /* ... same as before ... */ };
        const motivationalQuotes = [ /* ... same as before ... */ ];
        const statusLevels = { /* ... same as before ... */ };
        const schedulePlan = [ /* ... same as before ... */ ];

        // --- GLOBAL APP STATE ---
        let db, auth, userId;
        let currentProgress = {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- UI ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const quoteElement = document.getElementById('motivational-quote').querySelector('p');
        const daysLeftElement = document.getElementById('days-left');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const topicModal = document.getElementById('topic-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalTopicTitle = document.getElementById('modal-topic-title');
        const modalStatusOptions = document.getElementById('modal-status-options');
        const modalConfidenceStars = document.getElementById('modal-confidence-stars');
        const startDateInput = document.getElementById('start-date');
        const currentWeekView = document.getElementById('current-week-view');
        const revisionView = document.getElementById('revision-view');

        // --- INITIALIZATION ---
        
        function initializeAppWithConfig(config) {
            // ... same as before ...
        }
        
        function setupAuthListener() {
            // ... same as before ...
        }

        function setupUI() {
            // ... same as before ...
            
            // Schedule listeners
            startDateInput.addEventListener('change', async () => {
                await updateScheduleData({ startDate: startDateInput.value });
            });

            // Add event listener for clickable topic links in the schedule
            document.getElementById('schedule-content').addEventListener('click', e => {
                const target = e.target.closest('.topic-link');
                if (target) {
                    const subject = target.dataset.subject;
                    const topic = target.dataset.topic;
                    openTopicModal(subject, topic);
                }
            });
        }

        // --- FIREBASE & DATA HANDLING ---

        function listenToProgress() {
            if (!userId) return;
            const docRef = doc(db, "artifacts", appId, "users", userId);
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentProgress = docSnap.data();
                } else {
                    // Initialize document
                    const initialData = {
                        schedule: {
                            startDate: '2025-07-10',
                        }
                        // ... rest of initialization
                    };
                    setDoc(docRef, initialData);
                    currentProgress = initialData;
                }
                updateAllUI();
            });
        }

        async function updateScheduleData(dataToUpdate) {
            // ... same as before ...
        }

        async function updateTopicProgress(subject, topic, newStatus, newConfidence) {
            // ... same as before, but add lastUpdated timestamp
            const updatePayload = {};
            // ...
            updatePayload[`${subject}.${topic}.lastUpdated`] = new Date().toISOString();
            await updateDoc(docRef, updatePayload);
        }

        // --- UI RENDERING & UPDATES ---
        
        function updateAllUI() {
            if (!currentProgress || Object.keys(currentProgress).length === 0) return;
            // ... update dashboard and subject tabs ...
            renderDynamicSchedule();
        }

        function renderDynamicSchedule() {
            const scheduleData = currentProgress.schedule || { startDate: '2025-07-10' };
            startDateInput.value = scheduleData.startDate;

            const startDate = new Date(scheduleData.startDate + 'T00:00:00');
            const today = new Date();
            const diffTime = today - startDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const currentWeekNumber = Math.floor(diffDays / 7) + 1;

            if (currentWeekNumber > 0 && currentWeekNumber <= schedulePlan.length) {
                const weekData = schedulePlan[currentWeekNumber - 1];
                
                const weekStartDate = new Date(startDate);
                weekStartDate.setDate(startDate.getDate() + (currentWeekNumber - 1) * 7);
                const weekEndDate = new Date(weekStartDate);
                weekEndDate.setDate(weekStartDate.getDate() + 6);

                const subjects = ['physics', 'chemistry', 'mathematics'];
                let weeklyTopics = [];
                subjects.forEach(subject => {
                    const topicString = weekData[subject];
                    const topics = topicString.split(',').map(t => t.trim());
                    topics.forEach(topic => weeklyTopics.push({ subject, topic }));
                });

                let completedTopics = 0;
                weeklyTopics.forEach(t => {
                    const progress = currentProgress[t.subject]?.[t.topic];
                    if (progress && progress.status !== 'Not Started') {
                        completedTopics++;
                    }
                });

                const weeklyProgressPercent = weeklyTopics.length > 0 ? (completedTopics / weeklyTopics.length) * 100 : 0;

                currentWeekView.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-baseline">
                            <h2 class="text-2xl font-bold text-slate-800">This Week's Plan (Week ${currentWeekNumber})</h2>
                            <p class="text-sm text-slate-500">${weekStartDate.toLocaleDateString()} - ${weekEndDate.toLocaleDateString()}</p>
                        </div>
                        <p class="mt-1 text-base italic text-blue-600">Weekly Goal: ${weekData.goal}</p>
                        
                        <div class="mt-4">
                            <h3 class="text-md font-semibold text-slate-700">Weekly Progress</h3>
                            <div class="relative pt-1 mt-2">
                                <div class="overflow-hidden h-3 text-xs flex rounded-full bg-slate-200">
                                    <div style="width: ${weeklyProgressPercent}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-green-500 transition-all duration-500"></div>
                                </div>
                                <p class="text-right text-sm font-medium text-green-600 mt-1">${Math.round(weeklyProgressPercent)}%</p>
                            </div>
                        </div>

                        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                            ${subjects.map(subject => `
                                <div>
                                    <h4 class="text-lg font-semibold text-slate-800 capitalize border-b-2 pb-2 border-${subject === 'physics' ? 'red' : subject === 'chemistry' ? 'green' : 'blue'}-500">${subject}</h4>
                                    <ul class="mt-3 space-y-2">
                                        ${weekData[subject].split(',').map(topic => `
                                            <li class="text-sm text-slate-600 topic-link" data-subject="${subject}" data-topic="${topic.trim()}">
                                                <i class="fa-solid fa-arrow-right-long text-xs mr-2 text-slate-400"></i> ${topic.trim()}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                currentWeekView.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center"><p class="text-slate-600">The schedule has not started yet or has finished. Please adjust the start date.</p></div>`;
            }

            renderRevisionList();
        }

        function renderRevisionList() {
            let topicsForRevision = [];
            Object.keys(jeeSyllabus).forEach(subject => {
                jeeSyllabus[subject].forEach(topicInfo => {
                    const progress = currentProgress[subject]?.[topicInfo.topic];
                    if (progress && progress.status !== 'Not Started' && progress.confidence > 0 && progress.confidence < 3) {
                        topicsForRevision.push({ subject, topic: topicInfo.topic, confidence: progress.confidence });
                    }
                });
            });

            // Sort by lowest confidence first
            topicsForRevision.sort((a, b) => a.confidence - b.confidence);

            if (topicsForRevision.length > 0) {
                revisionView.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-2xl font-bold text-slate-800">Topics for Revision</h2>
                        <p class="mt-1 text-sm text-slate-500">These are topics you've studied but have a low confidence score. It's a good idea to review them!</p>
                        <ul class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${topicsForRevision.slice(0, 9).map(t => `
                                <li class="p-3 bg-amber-50 rounded-md topic-link" data-subject="${t.subject}" data-topic="${t.topic}">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-sm text-amber-800">${t.topic}</span>
                                        <div class="text-amber-500">
                                            ${[...Array(5)].map((_, i) => `<i class="fa-solid fa-star ${i < t.confidence ? 'text-amber-400' : 'text-slate-300'}"></i>`).join('')}
                                        </div>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            } else {
                revisionView.innerHTML = '';
            }
        }
        
        // --- ENTRY POINT ---
        window.onload = () => {
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                document.body.innerHTML = `<div class="p-8 text-center text-red-600"><h1>Configuration Missing</h1><p>Please open the index.html file, find the 'firebaseConfig' constant, and paste your configuration object from the Firebase console.</p></div>`;
                return;
            }
            initializeAppWithConfig(firebaseConfig);
        };
    </script>
</body>
</html>